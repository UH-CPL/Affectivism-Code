---
title: "citation_analysis_ratio"
# author: "Emtiaz"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(ggplot2)
library(scales)
library(zoo)
library(ggpubr)
library(lubridate)
```

### Read all files
```{r echo=FALSE, warning=FALSE, message=FALSE}
df_emotion_pubmed = read.csv("Data/publication_emotion.csv",stringsAsFactors = FALSE)
df_behavior_pubmed = read.csv("Data/publication_behavior.csv",stringsAsFactors = FALSE)

df_emotion_pubmed
df_behavior_pubmed

```



#### Get year from Publication date
```{r echo=FALSE, warning=FALSE, message=FALSE}
df_emotion_pubmed = df_emotion_pubmed %>% mutate(year = year(parse_date_time(published_date, orders = c("%Y-%m-%d", "%d.%m.%Y", "%d/%m/%Y",
                                                                                                   "%m/%d/%Y", "%m/%d/%y"), locale = "eng")))

df_emotion_pubmed

df_behavior_pubmed = df_behavior_pubmed %>% mutate(year = year(parse_date_time(published_date, orders = c("%Y-%m-%d", "%d.%m.%Y", "%d/%m/%Y",
                                                                                                   "%m/%d/%Y", "%m/%d/%y"), locale = "eng")))

df_behavior_pubmed
```


### Filter year from 1987 to 2018
```{r echo=FALSE, warning=FALSE, message=FALSE}

df_emotion_pubmed = df_emotion_pubmed %>% filter(year >= 1987 & year<=2018)
df_emotion_pubmed

df_behavior_pubmed = df_behavior_pubmed %>% filter(year >= 1987 & year<=2018)
df_behavior_pubmed



```

#### Add Publication Type
```{r echo=FALSE, warning=FALSE, message=FALSE}
df_emotion_pubmed = df_emotion_pubmed %>% mutate(emotionType = 1)
df_behavior_pubmed = df_behavior_pubmed %>% mutate(emotionType = 0)

df_emotion_pubmed
df_behavior_pubmed

```

### Join emotion and behavior
```{r echo=FALSE, warning=FALSE, message=FALSE}
df_all = rbind(df_emotion_pubmed, df_behavior_pubmed)
df_all
```

### change data types
```{r echo=FALSE, warning=FALSE, message=FALSE}
df_all$year = as.integer(df_all$year)
df_all$citations = as.integer(df_all$citations)
df_all$emotionType = as.integer(df_all$emotionType)
df_all
```
#### Remove duplicate entries
```{r echo=FALSE, warning=FALSE, message=FALSE}
df_all = df_all %>% group_by(PubmedID) %>% summarise(year = min(year), citations = max(citations), emotionTypes = sum(emotionType))
df_all
```

#### Add log Citation
```{r echo=FALSE, warning=FALSE, message=FALSE}
df_all = df_all %>% mutate(logCitation = log(1+citations))
df_all
```
### yearly Mean Citation
```{r echo=FALSE, warning=FALSE, message=FALSE}

mean_df = df_all %>% group_by(year) %>% summarise(mean_logCitation = mean(logCitation))
mean_df
```

#### Again Seperate Emotions
```{r echo=FALSE, warning=FALSE, message=FALSE}
df_only_emo = df_all %>% filter(emotionTypes == 1)
df_only_emo

df_only_behavior = df_all %>% filter(emotionTypes == 0)
df_only_behavior
```
#### Calculate the MEAN
```{r echo=FALSE, warning=FALSE, message=FALSE}

yearly_emotion = df_only_emo %>% group_by(year) %>% summarise(mean_citation = mean(logCitation))
yearly_behavior = df_only_behavior %>% group_by(year) %>% summarise(mean_citation_behavior = mean(logCitation))


yearly_emotion
yearly_behavior
```

### Join emotion and behavior
```{r echo=FALSE, warning=FALSE, message=FALSE}
yearly_data = yearly_emotion %>% left_join(yearly_behavior, by='year')
yearly_data
```


### Calculate Rc value
```{r echo=FALSE, warning=FALSE, message=FALSE}
yearly_data = yearly_data %>% mutate(rc = (mean_citation / mean_citation_behavior))
yearly_data
```

#### Average Rc value

```{r echo=FALSE, warning=FALSE, message=FALSE}

y_data = yearly_data %>% filter(year > 1989)

average_rc = round(mean(y_data$rc),2)
average_rc

```


#### Bootstrap part

### include bootstrap library 
```{r echo=FALSE, warning=FALSE, message=FALSE}
library(boot)

```

```{r echo=FALSE, warning=FALSE, message=FALSE}
### set the same seed. So, everytime I will get the same result

set.seed(42)

B = 1000000


result_95_pos = rep(NA, 32)
result_95_neg = rep(NA, 32)

result_90_pos = rep(NA, 32)
result_90_neg = rep(NA, 32)

result_99_pos = rep(NA, 32)
result_99_neg = rep(NA, 32)

# n = 50

for (i in 1987:2018) {
  temp = rep(NA, B)
  
  t_df = df_all %>% filter(year == i)
  n = as.integer(nrow(df_all %>% filter(year == i) %>% filter(emotionTypes == 1)) / 4)
  # n = 50
  
  
  for (j in 1:B){
    
    sample_df = t_df[sample(nrow(t_df), n, replace = FALSE),]
    
    emo_sample = sample_df %>% filter(emotionTypes == 1)
    behave_sample = sample_df %>% filter(emotionTypes == 0)
    
    if (nrow(emo_sample) == 0 | nrow(behave_sample) == 0){
      temp[j] = 1
      
    }else{
       mean_emo = mean(emo_sample$logCitation)
       mean_behave = mean(behave_sample$logCitation)
       rc_t = mean_emo / mean_behave
       temp[j] = rc_t
      
    }
    

   
    
  }
  
 
  
  a = 1
  # n = 10
  s = sd(temp)
  error_95 = qt(0.975, df = n-1) * s / sqrt(n)
  error_90 = qt(0.95, df = n-1) * s / sqrt(n)
  error_99 = qt(0.995, df = n-1) * s / sqrt(n)

  
  result_95_pos[i-1986] = a + error_95
  result_95_neg[i-1986] = a - error_95
  
  result_90_pos[i-1986] = a + error_90
  result_90_neg[i-1986]= a - error_90
  
  result_99_pos[i-1986] = a + error_99
  result_99_neg[i-1986] = a - error_99
  
  
}

result_90 = c(result_90_pos, result_90_neg)
result_95 = c(result_95_pos, result_95_neg)
result_99 = c(result_99_pos, result_99_neg)


year = rep(1987:2018,2)
type = rep(c('pos', 'neg'), each = 32)
boot_result_df = data.frame('year' = year, 'positive_90' = result_90_pos, 'negative_90' = result_90_neg,
                            'positive_95' = result_95_pos, 'negative_95' = result_95_neg,
                            'positive_99' = result_99_pos, 'negative_99' = result_99_neg)

# boot_result_df = data.frame('year' = year, 'result_90' = result_90, 'result_95' = result_95, 'result_99' = result_99, 'type' = type)


boot_result_df
# write.csv(boot_result_df, "Data/bootstrap_v1.csv", row.names = FALSE)

```
```{r echo=FALSE, warning=FALSE, message=FALSE}
write.csv(boot_result_df, "Data/bootstrap.csv", row.names = FALSE)
```

#### Draw Rc plot with confidence_interval
```{r echo=FALSE, warning=FALSE, message=FALSE}
boot_result_df = read.csv("Data/bootstrap.csv",stringsAsFactors = FALSE)
# boot_result_df$year = as.factor(boot_result_df$year)
boot_result_df$positive_90 = as.double(boot_result_df$positive_90)
boot_result_df$negative_90 = as.double(boot_result_df$negative_90)
boot_result_df$positive_95 = as.double(boot_result_df$positive_95)
boot_result_df$negative_95 = as.double(boot_result_df$negative_95)
boot_result_df$positive_99 = as.double(boot_result_df$positive_99)
boot_result_df$negative_99 = as.double(boot_result_df$negative_99)
boot_result_df
```
```{r echo=FALSE, warning=FALSE, message=FALSE}


p2 = ggplot(yearly_data, aes(x=year, y=rc)) +
  geom_hline(yintercept=1, color = 'red' , linetype = 'longdash', size=1)+
  geom_point(color = 'blue', size=3) +
  geom_line(data= boot_result_df, aes(x=year, y = positive_90), color = 'red' , linetype = 'solid', alpha = 0.5)+
  geom_line(data= boot_result_df, aes(x=year, y = negative_90), color = 'red' , linetype = 'solid', alpha = 0.5)+
  geom_line(data= boot_result_df, aes(x=year, y = positive_95), color = 'black' , linetype = 'solid', alpha = 0.5)+
  geom_line(data= boot_result_df, aes(x=year, y = negative_95), color = 'black' , linetype = 'solid', alpha = 0.5)+
  geom_line(data= boot_result_df, aes(x=year, y = positive_99), color = 'black' , linetype = 'dashed', alpha = 0.5)+
  geom_line(data= boot_result_df, aes(x=year, y = negative_99), color = 'black' , linetype = 'dashed', alpha = 0.5)+
  geom_ribbon(data = boot_result_df, aes(x=year, ymax=positive_90, ymin=negative_90), fill="pink", alpha=.5, inherit.aes=FALSE) +
  coord_cartesian(xlim = c(1990.9,2014.1)) +
  scale_x_continuous(breaks = seq(1990,2015,by=4)) +
  scale_y_continuous(breaks = seq(0.8,1.25,by=.1), limits = c(0.8,1.25)) +
  theme_bw()+
  theme(panel.grid.major = element_blank(),
        axis.text=element_text(size=12, face="bold"),
        axis.title=element_text(size=24,face="bold"),
        legend.position = "none",
        axis.title.y = element_text(margin=margin(t=0,r=10,b=0,l=0)),
        axis.title.x = element_text(margin=margin(t=10,r=0,b=0,l=0)),
        panel.grid = element_blank()) +
  labs(x="", y=bquote(italic(r[c])), title = "")+
  annotate(geom = 'text', x = 2002, y = 0.8,
             label = "atop(italic(bar(r[c])) == 1.2)",
             parse = TRUE, color = 'black', size=8,face="bold")

p2

ggsave(paste0("Plots/rc_ratio_plot.png"), p2, height = 8, width = 10)
```

### Calculate percentage from Rc
### Join mean_logCitation and rc yearly 
```{r echo=FALSE, warning=FALSE, message=FALSE}
cal_C_df = yearly_data %>% left_join(mean_df, by='year')
cal_C_df
```
```{r echo=FALSE, warning=FALSE, message=FALSE}
cal_C_df = cal_C_df %>% mutate(C_percentage = 100 * (exp((rc-1)*mean_logCitation)-1))
cal_C_df

mean_C_val = round(mean((cal_C_df %>% filter(year > 1989))$C_percentage),2)
print(paste0("Mean C value: ", mean_C_val, "%"))

```















